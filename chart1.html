<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<style> circle {fill: lightblue; stroke: black;} </style>
<body onload="init()">
<div style="margin-top:5px">
<div style="margin-left:30px; width:300px; height:100%; float:left">
<h2>Lung and Bronchus Cancer Rates: 1975-2016</h2>
<p>Here in the right is a figure showing the trend of lung and bronchus cancer from year 1975 to 2016. It displays the incidents rates of each year, in terms of No. of incidents per 100'000 people.</p>
<p>We can see that there is a trend of growth with lung and bronchus cancer incident rate from 1975 to 1990, and then gradually drops after 1990.</p>
<p>What is the reason behind the change? What makes the drop of lung/bronchus cancer rate? Click <b>"Next"</b> for more info.</p>	
</div>
<div style="margin-left:30px; height:100%; float:left">
<div id="tooltip" name="tooltip" opacity=0></div>
<svg width=900 height=450>
</svg>
<script>
async function init() {
	const data =  Object.assign((await d3.csv("https://raw.githubusercontent.com/ericstarmars/datavis_yangliu/master/incident_rate_over_year.csv"))
	.map(({year_of_disagnose, incident_rate}) => 
	({year:year_of_disagnose, value:incident_rate})), 
	{x:"Year", y: "Incidents Per 100'000"});
	var height = 450;
	var width = 900;
	var margin1 = ({top: 60, right: 120, bottom: 30, left: 90});
	var innerwidth = width - margin1.left - margin1.right;
	var innerheight = height - margin1.top - margin1.bottom;
	
	var x = d3.scaleLinear()
    .domain(d3.extent(data, d => d.year))
	.nice()
	.range([0, innerwidth])
    //.range([margin1.left, width - margin1.right])

	var yMarginUp = 4;
	var yMarginDown = 0;
	var y = d3.scaleLinear()
    .domain([d3.min(data, d => d.value) - yMarginUp, d3.max(data, d => d.value) + yMarginDown])
	.nice()
    .range([innerheight, 0]);
		
	var line = d3.line()
    .x(d => x(d.year))
    .y(d => y(d.value));

	var xAxis = g1 => g1
    .attr("transform", `translate(${margin1.left}, ${height - margin1.bottom})`)
	.style("font-size", "15px")
    .call(d3.axisBottom(x))
	.call(g1 => g1.select(".tick:last-of-type text").clone()
		.attr("x", 55)
		.attr("y", -5)
		.attr("text-anchor", "end")
		.attr("font-weight", "bold")
		.attr("font-size", "16px")
		.text(data.x));

	var yAxis = g2 => g2
    .attr("transform", `translate(${margin1.left},${margin1.top})`)
	.style("font-size", "15px")
    .call(d3.axisLeft(y))
    .call(g2 => g2.select(".tick:last-of-type text").clone()
		.attr("y", -25)
		.attr("x", -80)
		.attr("text-anchor", "start")
		.attr("font-weight", "bold")
		.attr("font-size", "16px")
		.text(data.y));

	var mysvg = d3.select("svg")
	.attr("viewBox", [0, 0, width, height])

	mysvg.append("g")
		.call(xAxis);

	mysvg.append("g")
		.call(yAxis);
	  
	var myfocus = mysvg.append("g")
		.style("display", "none")
		.attr("transform", "translate("+margin1.left+","+margin1.top+")");		
		
    // append the circle for mouseover
	myfocus.append("circle")
		.attr("class", "y")
		.style("fill", "none")
		.style("stroke", "red")
		.style("stroke-width", 3)
		.attr("r", 10);

	// append the x line for mouseover
	myfocus.append("line")
		.attr("class", "x")
		.style("stroke", "blue")
		.style("stroke-dasharray", "3,3")
		.style("opacity", 0.5)
		.attr("y1", 0)
		.attr("y2", innerheight);
		
    // append the y line for mouseover
	myfocus.append("line")
		.attr("class", "y")
		.style("stroke", "blue")
		.style("stroke-dasharray", "3,3")
		.style("opacity", 0.5)
		.attr("x1", innerwidth)
		.attr("x2", innerwidth);

	// append the value for mouseover
	myfocus.append("text")
		.attr("class", "y1")
		.style("stroke", "white")
		.style("stroke-width", "3.5px")
		.style("opacity", 0.8)
		.attr("dx", 20)
		.attr("dy", "-.4em");
	myfocus.append("text")
		.attr("class", "y2")
		.attr("dx", 20)
		.attr("dy", "-.4em");

	// append the year for mouseover
	myfocus.append("text")
		.attr("class", "y3")
		.style("stroke", "white")
		.style("stroke-width", "3.5px")
		.style("opacity", 0.8)
		.attr("dx", 20)
		.attr("dy", "1em");
	myfocus.append("text")
		.attr("class", "y4")
		.attr("dx", 20)
		.attr("dy", "1em");

	var mypath = mysvg.append("path")
		  .datum(data)
		  .attr("transform", "translate("+margin1.left+","+margin1.top+")")
		  .attr("fill", "none")
		  .attr("stroke", "steelblue")
		  .attr("stroke-width", 4)
		  .attr("stroke-linejoin", "miter")
		  .attr("stroke-linecap", "square")
		  .attr("d", line)
		  .attr("id", "mypath")
		  .style("pointer-events", "all")
		  .on("mouseover", function() { myfocus.style("display", null); })
		  .on("mouseout", function() { myfocus.style("display", "none"); })
		  .on("mousemove", mousemove)
		  .style("opacity", 1);
	mypath.transition().duration(5000).ease(d3.easeLinear).style("opacity", 1)
	
	var bisectYear = d3.bisector(function(d) { return d.year; }).left;
	function mousemove() {
		var x0 = x.invert(d3.mouse(this)[0]);
		var i = bisectYear(data, x0, 1);
		var d0 = data[i - 1];
		var d1 = data[i];
		var d = x0 - d0.year > d1.year - x0 ? d1 : d0;
		myfocus.select("text.y1")
			.attr("transform",
			"translate(" + x(d.year) + "," + y(d.value) + ")")
			.text("Incident rate: " + d.value);

		myfocus.select("text.y2")
			.attr("transform",
			"translate(" + x(d.year) + "," + y(d.value) + ")")
			.text("Incident rate: " + d.value);

		myfocus.select("text.y3")
			.attr("transform",
			"translate(" + x(d.year) + "," + y(d.value) + ")")
			.text("Year: " + d.year);

		myfocus.select("text.y4")
			.attr("transform",
			"translate(" + x(d.year) + "," + y(d.value) + ")")
			.text("Year: " + d.year);

		myfocus.select("line.x")
			.attr("transform",
			"translate(" + x(d.year) + "," + y(d.value) + ")")
			     .attr("y2", innerheight - y(d.value));

		myfocus.select("line.y")
			.attr("transform",
			"translate(" + innerwidth * -1 + "," + y(d.value) + ")")
			     .attr("x2", 2 * innerwidth);
		
		myfocus.select("circle.y")
			.attr("transform",
			"translate(" + x(d.year) + "," + y(d.value) + ")");
	}
}
</script>
</div>
</div>
</body>
</html>	
